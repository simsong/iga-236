{% extends "base.html" %}
{% block content %}
<h2> Dashboard </h2>
{% if next_lab and next_deadline %}
<p>Lab {{ next_lab }} due: <span id="deadline-display">{{ next_deadline }}</span>
       (<span id="days">0</span> days, <span id="hours">0</span> hours, <span id="minutes">0</span> minutes,
       <span id="seconds">0</span> seconds) <i>({{ timezone_display }})</i>
</p>
{% endif %}
<h3>User Info</h3>
<table class="pure-table">
  <thead>
  </thead>
  <tbody>
    <tr><th>Preferred Name</th><td>{{ user.preferred_name }}</td></tr>
    <tr><th>Email</th><td>{{ user.email }}</td></tr>
    <tr><th>course_key</th><td>{{ user.course_key }}</td></tr>
    <tr><th>Web browser IP address:</th><td>{{ client_ip }}</td></tr>
    {% if user.public_ip %}
    <tr><th>Instance public IP address:</th><td>{{ user.public_ip }}</td></tr>
    <tr><th>Access:</th><td><span class="check-btn">(check)</span></td></tr>
    {% else %}
    <tr><th>Instance not registered</th><td><a href="/dashboard">(reload)</a></td></tr>
    {% endif %}
  </tbody>
</table>

<h3>User Log</h3>
<table class="pure-table">
  <thead>
    <tr><th class="date">date</th><th class="client_ip">client_ip</th><th class="message">message</th><th class="claims">claims</th></tr>
  </thead>
  <tbody>
    {% for log in logs %}
    <tr>
      <th class="date">{{ log.datetime }}</th>
      <td class="client_ip">{{ log.client_ip }}</td>
      <td class="message">{{ log.message }}</td>
      <td class="claims">{{ log.claims }}</td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<h3>Grades</h3>
<p><i>Note: Only the highest grade for each lab is recorded in Canvas.</i></p>
<table class="pure-table">
  <thead>
    <tr>
      <th class="date">date</th>
      <th class="lab">lab</th>
      <th class="public_ip">IP Address</th>
      <th class="score">score</th>
      <th>Checks passed</th>
      <th>Checks failed</th>
    </tr>
  </thead>
  <tbody>
  {% for grade in grades %}
  <tr>
    <th class="date">{{ grade.datetime }}</th>
    <th class="lab">{{ grade.lab }}</th>
    <th class="public_ip">{{ grade.public_ip }}</th>
    <th class="score">{{ grade.score }}</th>
    <th class="pass_names">
      <ul>
        {% for name in grade.pass_names %}
        <li> {{ name }} </li>
        {% endfor %}
      </ul>
    </th>
    <th class="fail_names">
      <ul>
        {% for name in grade.fail_names %}
        <li> {{ name }} </li>
        {% endfor %}
      </ul>
    </th>
  </tr>
  {% endfor %}
  </tbody>
</table>

{% if images %}
<h3>Lab8 Images</h3>
<table class="pure-table">
  <thead>
    <tr><th>sk</th><th>image</th><th>delete</th></tr>
  </thead>
  <tbody>
    {% for image in images %}
    <tr>
      <th>{{ image.sk }}</th>
      <th><img src="{{ image.url }}" width="320" height="240" alt="image you uploaded"></th>
      <td><span class="delete-image"
                data-user_id="{{ user.user_id }}"
                data-sk="{{ image.sk }}"
                data-bucket="{{ image.bucket }}"
                data-key="{{ image.key }}">×</span></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% endif %}

<h3>Authenticated Sessions</h3>
  <h4>Active Sessions Table</h4>
  <table class="pure-table">
  <thead>
    <tr><th>Session #</th><th>sid</th><th colspan="2">Created</th><th>Expires</th><th>Delete</th></tr>
  </thead>
  <tbody>
    {% for session in sessions %}
    <tr class="{% if session.sid==ses.sid %}current-session{% endif %}" >
      <th>{{ loop.index }}</th>
      <th>{{ session.sid }}</th>
      <td>{{ session.session_created | eastern }} {{ session.client_ip }}</td>
      <td>{{ session.session_expire |eastern }}</td>
      <td><span class="delete-session"  data-sid="{{ session.sid }}">×</span></td>
    </tr>
    {% endfor %}
  </tbody>
</table>
<p>All times in {{ timezone_display }}.</p>
<p><i>Note: Once a session is created from a specific IP address, it can be used from any IP address. This is required to allow users to transition between Wi-Fi access points or from Wi-Fi to cellular networks.</i></p>


<script>
document.addEventListener("DOMContentLoaded", () => {
   // Countdown timer for next lab deadline
   {% if next_lab and next_deadline %}
   (function updateCountdown() {
     const deadline = new Date("{{ next_deadline }}");
     const now = new Date();
     const diff = deadline - now;

     if (diff <= 0) {
       document.getElementById("days").textContent = "0";
       document.getElementById("hours").textContent = "0";
       document.getElementById("minutes").textContent = "0";
       document.getElementById("seconds").textContent = "0";
       return;
     }

     const days = Math.floor(diff / (1000 * 60 * 60 * 24));
     const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
     const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
     const seconds = Math.floor((diff % (1000 * 60)) / 1000);

     document.getElementById("days").textContent = days.toString();
     document.getElementById("hours").textContent = hours.toString();
     document.getElementById("minutes").textContent = minutes.toString();
     document.getElementById("seconds").textContent = seconds.toString();

     setTimeout(updateCountdown, 1000);
   })();
   {% endif %}

   document.querySelectorAll(".delete-image").forEach(btn => {
     btn.style.cursor = "pointer"; // make it obvious it is clickable
     btn.addEventListener("click", async (event) => {
       const user_id = btn.dataset.user_id;
       const sk = btn.dataset.sk;
       const bucket = btn.dataset.bucket;
       const key = btn.dataset.key;
       console.log("user_id=",user_id,"bucket=",bucket,"sk=",sk,"key=",key);
       try {
         const resp = await fetch("{{ API_PATH }}", {
           method: "POST",
           headers: { "Content-Type": "application/json" },
           body: JSON.stringify({ action: "delete-image", user_id:user_id, bucket:bucket, sk:sk, key:key
           })
         });

         if (resp.ok) {           // Remove the row containing the clicked button
           btn.closest("tr").remove();
         } else {
           btn.textContent = "failed";
           btn.classList.add = "failed";
           console.error("Delete failed:", resp.status, resp.statusText, "body:",await resp.text());
         }
       } catch (err) {
         btn.textContent = "delete image failed";
         btn.classList.add = "failed";
         console.error("Fetch error:", err);
       }
     });
   });



   document.querySelectorAll(".delete-session").forEach(btn => {
     btn.style.cursor = "pointer"; // make it obvious it is clickable
     btn.addEventListener("click", async (event) => {
       const sid = btn.dataset.sid;
       try {
         const resp = await fetch("{{ API_PATH }}", {
           method: "POST",
           headers: { "Content-Type": "application/json" },
           body: JSON.stringify({ action: "delete-session", sid: sid
           })
         });

         if (resp.ok) {           // Remove the row containing the clicked button
           btn.closest("tr").remove();
         } else {
           btn.textContent = "failed";
           btn.classList.add = "failed";
           console.error("Delete failed:", resp.status, resp.statusText, "body:",await resp.text());
         }
       } catch (err) {
         btn.textContent = "delete session failed";
         btn.classList.add = "failed";
         console.error("Fetch error:", err);
       }
     });
   });

   document.querySelectorAll(".check-btn").forEach(btn => {
     btn.style.cursor = "pointer"; // make it obvious it is clickable
     btn.addEventListener("click", async (event) => {
       btn.textContent = "Checking...";
       const sid = btn.dataset.sid;
       try {
         const resp = await fetch("{{ API_PATH }}", {
           method: "POST",
           headers: { "Content-Type": "application/json" },
           body: JSON.stringify({
             action: "check-access",
             auth: {
               email: "{{ user.email }}",
               course_key: "{{ user.course_key }}" }
           })
         });

         if (resp.ok) {           // Remove the row containing the clicked button
           const data = await resp.json();
           console.log("data:",data)
           btn.textContent = data.message;
         } else {
           btn.textContent = "Access check failed (1)";
           btn.classList.add = "failed";
         }
       } catch (err) {
         btn.textContent = "Access check failed (2)";
         btn.classList.add = "failed";
         console.error("Fetch error:", err);
       }
     });
   });


 });
</script>


{% endblock content %}
